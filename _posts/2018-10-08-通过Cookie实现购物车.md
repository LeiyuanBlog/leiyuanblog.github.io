---
layout:     post
title:      é€šè¿‡Cookieå®ç°è´­ç‰©è½¦
subtitle:   è´­ç‰©è½¦åŸºæœ¬å®ç°
date:       2018-10-08
author:     LY
header-img: img/post-bg-debug.png
catalog: true
tags:
    - Cookie
---
> æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„ä»¥ä¸‹ä¸»é¡µï¼Œå°¤å…¶æ˜¯ä»Šæ—¥å¤´æ¡ï¼ï¼ï¼è°¢è°¢ğŸ™ğŸ™ğŸ™
>
> csdnï¼š[é›·å›­çš„csdnåšå®¢](https://blog.csdn.net/leiyuan2580)
>
> ä¸ªäººåšå®¢ï¼š[é›·å›­çš„ä¸ªäººåšå®¢](https://imlcl.store)
>
> ç®€ä¹¦ï¼š[é›·å›­çš„ç®€ä¹¦](https://www.jianshu.com/u/016322e40e1f)
>
> ä»Šæ—¥å¤´æ¡ï¼š[æ¥è‡ªåº•å±‚ç¨‹åºå‘˜çš„ä»°æœ›](https://www.toutiao.com/c/user/6132192948/#mid=1616456407686158)

# é€šè¿‡Cookieå®ç°è´­ç‰©è½¦

å¯¼åŒ…ï¼š

```java
import com.ambow.springboot.vo.CartVo;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.List;

```
### è·å–Cookie

```java

    /**
     * è·å–åä¸º"cart"çš„cookie
     *
     * @param request
     * @return cookie
     */
    public Cookie getCookie(HttpServletRequest request) {
        Cookie[] cookies = request.getCookies();
        Cookie cart_cookie = null;
        for (Cookie cookie : cookies) {
            if ("cart".equals(cookie.getName())) { //è·å–è´­ç‰©è½¦cookie
                cart_cookie = cookie;
            }
        }
        return cart_cookie;
    }

```

### è·å–Cookieä¸­çš„è´­ç‰©è½¦åˆ—è¡¨

```java

    /**
     * è·å–cookieä¸­çš„è´­ç‰©è½¦åˆ—è¡¨
     *
     * @param response
     * @param request
     * @return è´­ç‰©è½¦åˆ—è¡¨
     * @throws UnsupportedEncodingException æŠ›å‡ºå¼‚å¸¸
     */
    public List<CartVo> getCartInCookie(HttpServletResponse response, HttpServletRequest request) throws
            UnsupportedEncodingException {
        // å®šä¹‰ç©ºçš„è´­ç‰©è½¦åˆ—è¡¨
        List<CartVo> items = new ArrayList<CartVo>();
        String value_1st = "";
        // è´­ç‰©cookie
        Cookie cart_cookie = getCookie(request);
        // åˆ¤æ–­cookieæ˜¯å¦ä¸ºç©º
        if (cart_cookie != null) {
            // è·å–cookieä¸­Stringç±»å‹çš„value
            value_1st = URLDecoder.decode(cart_cookie.getValue(), "utf-8");//ä»cookieè·å–è´­ç‰©è½¦
            // åˆ¤æ–­valueæ˜¯å¦ä¸ºç©ºæˆ–è€…""å­—ç¬¦ä¸²
            if (value_1st != null && !"".equals(value_1st)) {
                // è§£æå­—ç¬¦ä¸²ä¸­çš„æ•°æ®ä¸ºå¯¹è±¡å¹¶å°è£…è‡³listä¸­è¿”å›ç»™ä¸Šä¸€çº§
                String[] arr_1st = value_1st.split("==");
                for (String value_2st : arr_1st) {
                    String[] arr_2st = value_2st.split("=");
                    CartVo item = new CartVo();
                    item.setGoodsId(Integer.parseInt(arr_2st[0])); //å•†å“id
                    item.setGoodsTypeId(Integer.parseInt(arr_2st[1])); //å•†å“ç±»å‹ID
                    item.setGoodsName(arr_2st[2]); //å•†å“å
                    item.setGoodsPrice(Integer.parseInt(arr_2st[3])); //å•†å“å¸‚åœºä»·æ ¼
                    item.setGoodsDiscount(Integer.parseInt(arr_2st[4]));//å•†å“æŠ˜åä»·æ ¼
                    item.setGoodsNum(Integer.parseInt(arr_2st[5]));//å•†å“æœˆé”€é‡
                    item.setGoodsInfo(arr_2st[6]);//å•†å“è¯¦æƒ…
                    item.setNum(Integer.parseInt(arr_2st[7]));//åŠ å…¥è´­ç‰©è½¦æ•°é‡
                    items.add(item);
                }
            }
        }
        return items;

    }
```

### åˆ¶ä½œcookieæ‰€éœ€value

```java

    /**
     * åˆ¶ä½œcookieæ‰€éœ€value
     *
     * @param cartVos è´­ç‰©è½¦åˆ—è¡¨
     * @return è§£æä¸ºå­—ç¬¦ä¸²çš„è´­ç‰©è½¦åˆ—è¡¨ï¼Œå±æ€§é—´ä½¿ç”¨"="ç›¸éš”ï¼Œå¯¹è±¡é—´ä½¿ç”¨"=="ç›¸éš”
     */
    public String makeCookieValue(List<CartVo> cartVos) {
        StringBuffer buffer_2st = new StringBuffer();
        for (CartVo item : cartVos) {
            buffer_2st.append(item.getGoodsId() + "=" + item.getGoodsTypeId() + "=" + item.getGoodsName() + "="
                    + item.getGoodsPrice() + "=" + item.getGoodsDiscount() + "=" + item.getGoodsNum() + "=" + item
                    .getGoodsInfo() + "=" + item.getNum() + "==");
        }
        return buffer_2st.toString().substring(0, buffer_2st.toString().length() - 2);
    }
```

### æ·»åŠ ï¼Œåˆ é™¤ï¼Œæ¸…ç©ºè´­ç‰©è½¦æ–¹æ³•

```java

    /**
     * æ ¹æ®IDåˆ é™¤åˆ é™¤è´­ç‰©è½¦å†…çš„å•†å“
     *
     * @param goodsId  å•†å“ID
     * @param request
     * @param response
     * @return æˆåŠŸä¸å¦
     * @throws UnsupportedEncodingException æŠ›å‡ºå¼‚å¸¸
     */
    @RequestMapping("/deleteByGoodsId/{goodsId}")
    public String deleteByGoodsId(@PathVariable("goodsId") Integer goodsId, HttpServletRequest request,
                                  HttpServletResponse response) throws UnsupportedEncodingException {
        // è·å–cookieä¸­è´­ç‰©è½¦åˆ—è¡¨
        List<CartVo> cartVos = getCartInCookie(response, request);
        CartVo deleteCart = null;
        // åˆ¤æ–­è´­ç‰©è½¦åˆ—è¡¨æ˜¯å¦ä¸ºç©º
        if (cartVos.size() > 0) {
            // å¾ªç¯è´­ç‰©è½¦åˆ—è¡¨å¯»æ‰¾ç›¸åŒIDçš„å•†å“
            for (CartVo c : cartVos) {
                if (c.getGoodsId().equals(goodsId)) {
                    deleteCart = c;
                    break;
                }
            }
            // åˆ¤æ–­æ˜¯å¦æ‰¾åˆ°ç›¸åŒIDçš„å•†å“
            if (deleteCart != null) {
                // åˆ¤æ–­è´­ç‰©è½¦ä¸­å•†å“çš„æ•°é‡
                if (deleteCart.getNum() > 1) {
                    // æ•°é‡å¤§äº1å¢è®©æ•°é‡-1
                    deleteCart.setNum(deleteCart.getNum() - 1);
                    cartVos.remove(deleteCart);
                    cartVos.add(deleteCart);
                } else {
                    // å¦åˆ™ç›´æ¥åˆ é™¤è¯¥å•†å“åœ¨è´­ç‰©è½¦ä¸­çš„ä¿¡æ¯
                    cartVos.remove(deleteCart);
                }
                // è·å–åä¸º"cart"çš„cookie
                Cookie cookie = getCookie(request);
                // ä¸ºcookieè®¾ç½®value
                cookie.setValue(URLEncoder.encode(makeCookieValue(cartVos), "utf-8"));
                // è®¾ç½®å¯¿å‘½
                cookie.setMaxAge(60 * 10);
                // è®¾ç½®è·¯å¾„
                cookie.setPath("/");
                // æ›´æ–°cookie
                response.addCookie(cookie);
            }
        }
        return "success";
    }

    /**
     * æ¸…ç©ºè´­ç‰©è½¦
     *
     * @param response
     * @param request
     * @return æˆåŠŸä¸å¦
     */
    @RequestMapping("/deleteAllCookie")
    public String deleteCookie(HttpServletResponse response, HttpServletRequest request) {
        // è·å–åä¸º"cart"çš„cookie
        Cookie cookie = getCookie(request);
        // è®¾ç½®å¯¿å‘½ä¸º0ç§’
        cookie.setMaxAge(0);
        // è®¾ç½®è·¯å¾„
        cookie.setPath("/");
        // è®¾ç½®cookieçš„valueä¸ºnull
        cookie.setValue(null);
        // æ›´æ–°cookie
        response.addCookie(cookie);
        return "success";
    }

    /**
     * è·å–è´­ç‰©è½¦åˆ—è¡¨
     *
     * @param request
     * @param response
     * @return è´­ç‰©è½¦åˆ—è¡¨
     * @throws UnsupportedEncodingException æŠ›å‡ºå¼‚å¸¸
     */
    @RequestMapping("/getCart")
    public List<CartVo> getCart(HttpServletRequest request, HttpServletResponse response) throws
            UnsupportedEncodingException {
        return getCartInCookie(response, request);
    }

    /**
     * æ·»åŠ å•†å“è‡³è´­ç‰©è½¦åˆ—è¡¨
     *
     * @param goodsId  å•†å“ID
     * @param request
     * @param response
     * @throws UnsupportedEncodingException å¼‚å¸¸æŠ›å‡º
     */
    @RequestMapping("/addGoodsToCart/{goodsId}")
    public void addGoodsToCart(@PathVariable("goodsId") Integer goodsId, HttpServletRequest request,
                               HttpServletResponse response) throws UnsupportedEncodingException {
        // ä»cookieä¸­è·å–è´­ç‰©è½¦åˆ—è¡¨
        List<CartVo> cartVos = getCartInCookie(response, request);
        Cookie cookie_2st;
        // å¦‚æœè´­ç‰©è½¦åˆ—è¡¨ä¸ºç©º
        if (cartVos.size() <= 0) {
            //TODO æ ¹æ®å•†å“IDè·å–å•†å“ä¿¡æ¯
            CartVo cartVo = new CartVo(); // æµ‹è¯•ç”¨ï¼Œå®é™…åº”å½“æ ¹æ®idè·å–
            cartVo.setNum(1);
            cartVo.setGoodsId(1);
            cartVo.setGoodsNum(1);
            cartVo.setGoodsTypeId(1);
            cartVo.setGoodsPrice(1);
            cartVo.setGoodsDiscount(1);
            cartVo.setGoodsName("é›·å›­");
            // å°†å½“å‰ä¼ æ¥çš„å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦åˆ—è¡¨
            cartVos.add(cartVo);
            if (getCookie(request) == null) {
                // åˆ¶ä½œè´­ç‰©è½¦cookieæ•°æ®
                cookie_2st = new Cookie("cart", URLEncoder.encode(makeCookieValue(cartVos), "utf-8"));
                cookie_2st.setPath("/");//è®¾ç½®åœ¨è¯¥é¡¹ç›®ä¸‹éƒ½å¯ä»¥è®¿é—®è¯¥cookie
                cookie_2st.setMaxAge(60 * 30);//è®¾ç½®cookieæœ‰æ•ˆæ—¶é—´ä¸º30åˆ†é’Ÿ
                response.addCookie(cookie_2st);//æ·»åŠ cookie
            } else {
                cookie_2st = getCookie(request);
                cookie_2st.setPath("/");//è®¾ç½®åœ¨è¯¥é¡¹ç›®ä¸‹éƒ½å¯ä»¥è®¿é—®è¯¥cookie
                cookie_2st.setMaxAge(60 * 30);//è®¾ç½®cookieæœ‰æ•ˆæ—¶é—´ä¸º30åˆ†é’Ÿ
                cookie_2st.setValue(URLEncoder.encode(makeCookieValue(cartVos)));
                response.addCookie(cookie_2st);//æ·»åŠ cookie
            }
        }
        // å½“è·å–çš„è´­ç‰©è½¦åˆ—è¡¨ä¸ä¸ºç©ºæ—¶
        else {
            int bj = 0;
            for (CartVo cart : cartVos) {
                // å¦‚æœè´­ç‰©è½¦ä¸­å­˜åœ¨è¯¥å•†å“åˆ™æ•°é‡+1
                if (cart.getGoodsId() == goodsId) {
                    cart.setNum(cart.getNum() + 1);
                    bj = 1;
                    break;
                }
            }
            if (bj == 0) {
                //TODO æ ¹æ®å•†å“IDè·å–å•†å“ä¿¡æ¯
                CartVo cartVo = new CartVo(); // æµ‹è¯•ç”¨ï¼Œå®é™…åº”å½“æ ¹æ®idè·å–
                cartVo.setNum(1);
                cartVo.setGoodsId(goodsId);
                cartVo.setGoodsNum(1);
                cartVo.setGoodsTypeId(1);
                cartVo.setGoodsPrice(1);
                cartVo.setGoodsDiscount(1);
                cartVo.setGoodsName("æ¥è‡ªåº•å±‚ç¨‹åºå‘˜çš„ä»°æœ›");
                // å°†å½“å‰ä¼ æ¥çš„å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦åˆ—è¡¨
                cartVos.add(cartVo);
            }
            // è·å–åä¸º"cart"çš„cookie
            cookie_2st = getCookie(request);
            cookie_2st.setPath("/");//è®¾ç½®åœ¨è¯¥é¡¹ç›®ä¸‹éƒ½å¯ä»¥è®¿é—®è¯¥cookie
            cookie_2st.setMaxAge(60 * 30);//è®¾ç½®cookieæœ‰æ•ˆæ—¶é—´ä¸º30åˆ†é’Ÿ
            cookie_2st.setValue(URLEncoder.encode(makeCookieValue(cartVos))); // è®¾ç½®value
            response.addCookie(cookie_2st);//æ·»åŠ cookie
        }
    }

```