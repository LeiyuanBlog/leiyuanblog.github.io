---
layout:     post
title:      Dockerå•æœºéƒ¨ç½²æœåŠ¡å™¨å‹åŠ›å¤ªå¤§ï¼Ÿè¯¥å­¦ä¹ DockerSwarmé›†ç¾¤åŒ–éƒ¨ç½²äº†
subtitle:   Dockerå•æœºéƒ¨ç½²æœåŠ¡å™¨å‹åŠ›å¤ªå¤§ï¼Ÿè¯¥å­¦ä¹ DockerSwarmé›†ç¾¤åŒ–éƒ¨ç½²äº†
date:       2020-04-10
author:     LY
header-img: img/post-docker-bk.png
catalog: true
tags:
    - docker
	- ä¸“æ 

---

> æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„ä»¥ä¸‹ä¸»é¡µï¼Œå°¤å…¶æ˜¯ä»Šæ—¥å¤´æ¡ï¼ï¼ï¼è°¢è°¢ğŸ™ğŸ™ğŸ™
>
> csdnï¼š[é›·å›­çš„csdnåšå®¢](https://blog.csdn.net/leiyuan2580)
>
> ä¸ªäººåšå®¢ï¼š[é›·å›­çš„ä¸ªäººåšå®¢](https://imlcl.store)
>
> ç®€ä¹¦ï¼š[é›·å›­çš„ç®€ä¹¦](https://www.jianshu.com/u/016322e40e1f)
>
> ä»Šæ—¥å¤´æ¡ï¼š[æ¥è‡ªåº•å±‚ç¨‹åºå‘˜çš„ä»°æœ›](https://www.toutiao.com/c/user/6132192948/#mid=1616456407686158)

## Dockerå•æœºéƒ¨ç½²æœåŠ¡å™¨å‹åŠ›å¤ªå¤§ï¼Ÿè¯¥å­¦ä¹ DockerSwarmé›†ç¾¤åŒ–éƒ¨ç½²äº†

### ä¾ç„¶æ˜¯ä¹ æƒ¯æ€§çš„å¼€å¤´è¯´å‡ å¥

1. é©¬ä¸Šå°±æ˜¯é™¤å¤•å•¦ï¼Œç°åœ¨è¿™é‡Œç»™å¤§å®¶æ‹œä¸ªå¹´ï¼æ–°å¹´å¿«ä¹å„ä½å°ä¼™ä¼´ã€‚
2. ç›´åˆ°è¿™ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬ç®—æ˜¯åŸºæœ¬è®²è¿°å®Œæ¯•äº†ï¼Œå¤§éƒ¨åˆ†ç›¸å…³çš„çŸ¥è¯†å’Œæ“ä½œæ–¹å¼æˆ‘ä»¬éƒ½å·²ç»è®²è¿‡å•¦ã€‚
3. ä¸Šä¸€ç« èŠ‚ä¸­æˆ‘ä»¬è®²è¿°äº†docker-composeç¼–æ’å·¥å…·æ‰¹é‡å¯åŠ¨å®¹å™¨ã€‚
4. ä½†æ˜¯åœ¨è¾ƒå¤šæ—¶å€™ï¼Œå•ä¸ªå®¿ä¸»æœºæ— æ³•å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„æ€§èƒ½éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±ä¼šç”¨åˆ°Docker Swarmäº†ã€‚

### æ­£å¼å¼€å§‹

#### ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨Docker Swarmé›†ç¾¤åŒ–éƒ¨ç½²

1. åœ¨å¤šæ•°æ—¶å€™ï¼Œå•ä¸ªæœåŠ¡å™¨æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„æ€§èƒ½éœ€æ±‚ã€‚
2. Docker Swarmå¯ä»¥å¯¹å®¹å™¨è¿›è¡ŒåŠ¨æ€æ‰©å®¹ã€‚

#### å¼€å§‹å‰çš„å‡†å¤‡å·¥ä½œ

1. æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸¤å°ï¼ˆåŠä»¥ä¸Šï¼‰çš„æœåŠ¡å™¨æˆ–è™šæ‹Ÿæœºã€‚
2. å®‰è£…å¹¶è¿è¡ŒDockeræœåŠ¡ã€‚
3. æˆ‘ä»¬é€‰æ‹©å…¶ä¸­ä¸€å°ä¸ºLeaderèŠ‚ç‚¹ï¼Œå…¶ä»–çš„å‡ä¸ºWorkerèŠ‚ç‚¹ã€‚
4. æ‰€æœ‰æœºå™¨å‡éœ€è¦å¼€æ”¾ä»¥ä¸‹ç«¯å£ï¼šTCP:2377ã€2376ã€7946ï¼›UDP:7946ã€4789ã€‚è¿™äº›ç«¯å£å‡æ˜¯Docker Swarmé€šè®¯æ‰€éœ€èŠ‚ç‚¹ã€‚

#### åˆ›å»ºDocker Swarmé›†ç¾¤

1. é¦–å…ˆæˆ‘ä»¬åœ¨é€‰ä¸­çš„LeaderèŠ‚ç‚¹ä¸­è¿›è¡Œé›†ç¾¤çš„åˆ›å»ºï¼Œ**--advertise-addr**å‚æ•°å¹¶éå¿…é¡»ï¼Œè‹¥**Leader**æ‹¥æœ‰å¤šä¸ªç½‘å¡å¯¹åº”çš„ipï¼Œè¯·ä½¿ç”¨è¯¥å‚æ•°æŒ‡å®šå…¶ä¸­ä¹‹ä¸€ï¼š

   ```shell
   $ docker swarm init --advertise-addr 192.168.99.100
   # æ‰§è¡Œç»“æœå¦‚ä¸‹
   Swarm initialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.
   
   To add a worker to this swarm, run the following command:
   
       docker swarm join --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c 192.168.99.100:2377
   
   To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
   ```

2. å…¶æ¬¡æˆ‘ä»¬å°±éœ€è¦åœ¨é€‰ä¸­çš„WorkerèŠ‚ç‚¹ä¸­æ‰§è¡Œå‘½ä»¤ä¸»åŠ¨åŠ å…¥é›†ç¾¤ï¼š

   ```shell
   # è¯¥å‘½ä»¤åŒ…å«åœ¨Leaderåˆ›å»ºé›†ç¾¤æ—¶è¿”å›å€¼ä¸­
   $ docker swarm join --token SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c 192.168.99.100:2377
   ```

3. æœ€åå‘¢ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨LeaderèŠ‚ç‚¹ä¸­æ£€æŸ¥ä¸€ä¸‹é›†ç¾¤çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼š``docker node ls``

4. è¿™æ ·ä»¥æ¥ï¼Œæˆ‘ä»¬çš„é›†ç¾¤ç®—æ˜¯éƒ¨ç½²å®Œæ¯•äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•çš„å¯åŠ¨ä¸€äº›å®¹å™¨ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœã€‚

#### ç®€å•å®ç°

1. æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªè·Ÿä¸Šä¸€ç« èŠ‚ç±»ä¼¼çš„ymlé…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­é…ç½®å¥½æˆ‘ä»¬æ‰€éœ€æœåŠ¡çš„ç›¸å…³å‚æ•°ï¼š

   ```yaml
   version: "3"
   services:
     redis:
       image: hub.c.163.com/library/redis:latest
       networks:
         overlay:
       command: redis-server --requirepass leiyuan
     zoo:
       image: zookeeper:latest
       ports:
         - 2181:2181
       restart: always
       networks:
         overlay:
     tomcat:
       image: tomcat
       ports:
         - 80:80
       networks:
         overlay:
       depends_on:
         - zoo
         - redis
       links:
         - redis:redis
         - zoo:zoo
   volumes:
     db-data:
   networks:
     overlay:
   ```

2. è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¯¥é…ç½®æ–‡ä»¶å¯åŠ¨ç›¸å…³çš„å®¹å™¨äº†ã€‚

#### å¸¸ç”¨çš„å‘½ä»¤

1. ç¦»å¼€é›†ç¾¤`docker swarm leave`
2. ç¦»å¼€å¹¶åˆ é™¤é›†ç¾¤`docker swarm leave --force`
3. åˆ é™¤æŒ‡å®šèŠ‚ç‚¹`docker node rm èŠ‚ç‚¹ID`
4. å¯åŠ¨`docker stack deploy -c docker-compose.yml leiyuan`
5. åœæ­¢`docker stack down leiyuan`
6. æŸ¥çœ‹swarmä¸­å®¹å™¨çš„ip`docker service inspect --format '{{ .Endpoint.VirtualIPs }}'  æœåŠ¡å`
7. æŸ¥çœ‹é›†ç¾¤ä¸­çš„æœåŠ¡`docker service ls`
8. åŠ¨æ€æ‰©å®¹ï¼Œä¿®æ”¹æœåŠ¡æ•°é‡`docker service scale æœåŠ¡å=æ•°é‡`

### æœ€åè¯´å‡ å¥

1. ä»Šå¤©å‘¢ï¼Œå°±æ˜¯å¤§å¹´ä¸‰åäº†ï¼Œç¥å¤§å®¶æ–°å¹´å¿«ä¹ã€‚å¸Œæœ›å¤§å®¶åœ¨æ–°çš„ä¸€å¹´é‡Œï¼Œå·¥ä½œé¡ºé¡ºåˆ©åˆ©ã€èº«ä½“å¥å¥åº·åº·ã€å®¶åº­å’Œå’Œç¦ç¦ã€çˆ±æƒ…ç”œç”œç¾ç¾ã€‚
2. æˆ‘ä»¬çš„ç« èŠ‚ç®—æ˜¯å…¨éƒ¨éƒ½æ›´æ–°å®Œäº†ï¼Œå¾ˆé«˜å…´æˆ‘è‡ªå·±å¯ä»¥åšæŒä¸‹æ¥ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œæˆ‘çš„æ”¶è·ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œï¼Œä¸çŸ¥é“å¤§å®¶æ˜¯å¦æœ‰æ‰€æ”¶è·å‘¢ï¼Ÿå¯ä»¥å¤§å®¶ä¸€èµ·åŠ å…¥åœˆå­äº¤æµæ²Ÿé€šã€‚
3. å¸Œæœ›ä»¥åï¼Œæˆ‘ä»¬è¿˜èƒ½ä¸€èµ·å­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥ï¼ï¼ï¼